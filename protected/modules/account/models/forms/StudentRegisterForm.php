<?php/** * This model is used for student registration form. * @author Wenbin * *@property User $user *@property Student $student  */class StudentRegisterForm extends RegisterForm{	public $student;    public $hash;	public function __construct()	{		parent::__construct();						$this->user->user_group_id=Student::USER_GROUP_ID;		$this->student=new Student();	}		public function rules()	{		return CMap::mergeArray(parent::rules(), array(				array('student','checkStudent'),				));	}		public function checkStudent($attribute,$params)	{		$ret=$this->student->validate();		if (!$ret) {			$this->addErrors($this->student->getErrors());		}	}		public function save()	{		//start a transaction		$transaction=Yii::app()->db->beginTransaction();		try {            if ($this->user->isNewRecord)            {                $this->user->is_verified = 0;                $verification = new UserVerification();            }            //try to save the data to db			$ret=parent::save();						if ($ret) {				$ret=$this->student->save(true,null,$this->user);                if (isset($verification))                {                    Yii::log("Verification is set");                    $verification->user_id = $this->user->user_id;                    $this->hash = $verification->generateHash();                    if (!$verification->save())                        throw new Exception;                   if (!Emailer::emailStudentActivation($this->user, $this->hash))                      throw new Exception;                }			}					$transaction->commit();			//Yii::app()->user->setFlash('success',sprintf(Constants::SUCCESS_SURVEY_SUBMITTED,$model->getSurvey()->title));			return $ret;		} catch (Exception $e) {			//if something happens, simply set the error message and redirect as normal			$transaction->rollback();			//Yii::app()->user->setFlash('error','Unable to create your account.');			return false;		}					}	}